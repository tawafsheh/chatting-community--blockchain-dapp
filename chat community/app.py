#!/usr/bin/python3
import json
from web3 import Web3
from web3.exceptions import ContractLogicError
from solcx import compile_standard, install_solc
from flask import Flask, render_template, request,session, redirect
from dotenv import load_dotenv
from web3.middleware import geth_poa_middleware
from datetime import datetime
import argparse

bytecode = "608060405260016005556001600655600160075534801561001f57600080fd5b50612b7c8061002f6000396000f3fe608060405234801561001057600080fd5b50600436106100935760003560e01c80636f77926b116100665780636f77926b146101325780638dc7aef2146101625780638ee93cf314610180578063e82935da1461019c578063f2c298be146101b857610093565b80630887c0ff146100985780631805c523146100c85780633c04ca62146100e457806341f3004a14610114575b600080fd5b6100b260048036038101906100ad919061209c565b6101d4565b6040516100bf91906126e8565b60405180910390f35b6100e260048036038101906100dd91906120c5565b610848565b005b6100fe60048036038101906100f9919061209c565b610ad2565b60405161010b919061270a565b60405180910390f35b61011c610f47565b604051610129919061272c565b60405180910390f35b61014c60048036038101906101479190612032565b6110a2565b60405161015991906127d0565b60405180910390f35b61016a6111b1565b604051610177919061274e565b60405180910390f35b61019a6004803603810190610195919061205b565b611816565b005b6101b660048036038101906101b1919061209c565b6119a3565b005b6101d260048036038101906101cd919061205b565b611cac565b005b606060008060005b60038054905081101561025e578460038281548110610224577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906006020160000154141561024b57818061024790612a31565b9250505b808061025690612a31565b9150506101dc565b5060008167ffffffffffffffff8111156102a1577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6040519080825280602002602001820160405280156102da57816020015b6102c7611dea565b8152602001906001900390816102bf5790505b50905060005b60038054905081101561083c578560038281548110610328577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000209060060201600001541415610829576003818154811061037a577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000209060060201600001548285815181106103c5577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160000181815250506003818154811061040f577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b90600052602060002090600602016001015482858151811061045a577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516020018181525050600381815481106104a4577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906006020160020180546104c0906129ff565b80601f01602080910402602001604051908101604052809291908181526020018280546104ec906129ff565b80156105395780601f1061050e57610100808354040283529160200191610539565b820191906000526020600020905b81548152906001019060200180831161051c57829003601f168201915b5050505050828581518110610577577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160400181905250600381815481106105c0577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906006020160030160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1682858151811061062b577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516060019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff1681525050600381815481106106a3577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906006020160040180546106bf906129ff565b80601f01602080910402602001604051908101604052809291908181526020018280546106eb906129ff565b80156107385780601f1061070d57610100808354040283529160200191610738565b820191906000526020600020905b81548152906001019060200180831161071b57829003601f168201915b5050505050828581518110610776577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160800181905250600381815481106107bf577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b90600052602060002090600602016005015482858151811061080a577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160a0018181525050838061082590612a31565b9450505b808061083490612a31565b9150506102e0565b50809350505050919050565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff166108d6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016108cd90612790565b60405180910390fd5b60006040518060c0016040528084815260200160065481526020016000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600001805461093d906129ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610969906129ff565b80156109b65780601f1061098b576101008083540402835291602001916109b6565b820191906000526020600020905b81548152906001019060200180831161099957829003601f168201915b505050505081526020013373ffffffffffffffffffffffffffffffffffffffff168152602001838152602001428152509050600381908060018154018082558091505060019003906000526020600020906006020160009091909190915060008201518160000155602082015181600101556040820151816002019080519060200190610a44929190611e36565b5060608201518160030160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506080820151816004019080519060200190610aa8929190611e36565b5060a08201518160050155505060066000815480929190610ac890612a31565b9190505550505050565b606060008060005b600480549050811015610b5c578460048281548110610b22577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000209060040201600001541415610b49578180610b4590612a31565b9250505b8080610b5490612a31565b915050610ada565b5060008167ffffffffffffffff811115610b9f577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b604051908082528060200260200182016040528015610bd857816020015b610bc5611ebc565b815260200190600190039081610bbd5790505b50905060005b600480549050811015610f3b578560048281548110610c26577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000209060040201600001541415610f285760048181548110610c78577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906004020160000154828581518110610cc3577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151600001818152505060048181548110610d0d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906004020160010154828581518110610d58577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151602001818152505060048181548110610da2577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b90600052602060002090600402016002018054610dbe906129ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610dea906129ff565b8015610e375780601f10610e0c57610100808354040283529160200191610e37565b820191906000526020600020905b815481529060010190602001808311610e1a57829003601f168201915b5050505050828581518110610e75577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516040018190525060048181548110610ebe577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b906000526020600020906004020160030154828581518110610f09577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160600181815250508380610f2490612a31565b9450505b8080610f3390612a31565b915050610bde565b50809350505050919050565b60606002805480602002602001604051908101604052809291908181526020016000905b828210156110995783829060005260206000209060040201604051806080016040529081600082015481526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600282018054610ffe906129ff565b80601f016020809104026020016040519081016040528092919081815260200182805461102a906129ff565b80156110775780601f1061104c57610100808354040283529160200191611077565b820191906000526020600020905b81548152906001019060200180831161105a57829003601f168201915b5050505050815260200160038201548152505081526020019060010190610f6b565b50505050905090565b6110aa611ee4565b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020604051806060016040529081600082018054611103906129ff565b80601f016020809104026020016040519081016040528092919081815260200182805461112f906129ff565b801561117c5780601f106111515761010080835404028352916020019161117c565b820191906000526020600020905b81548152906001019060200180831161115f57829003601f168201915b50505050508152602001600182015481526020016002820160009054906101000a900460ff1615151515815250509050919050565b6060600060028054905067ffffffffffffffff8111156111fa577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561123357816020015b611220611f07565b8152602001906001900390816112185790505b5090506000805b60028054905081101561180d57600060028281548110611283577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b9060005260206000209060040201604051806080016040529081600082015481526020016001820160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200160028201805461130c906129ff565b80601f0160208091040260200160405190810160405280929190818152602001828054611338906129ff565b80156113855780601f1061135a57610100808354040283529160200191611385565b820191906000526020600020905b81548152906001019060200180831161136857829003601f168201915b5050505050815260200160038201548152505090506000806000836020015173ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206040518060600160405290816000820180546113f9906129ff565b80601f0160208091040260200160405190810160405280929190818152602001828054611425906129ff565b80156114725780601f1061144757610100808354040283529160200191611472565b820191906000526020600020905b81548152906001019060200180831161145557829003601f168201915b50505050508152602001600182015481526020016002820160009054906101000a900460ff16151515158152505090506000816000015190506000805b8681101561167257846020015173ffffffffffffffffffffffffffffffffffffffff1688828151811061150b577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101516000015173ffffffffffffffffffffffffffffffffffffffff16141561165f578488828151811061156d577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151604001518983815181106115b2577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001015160600151815181106115f5577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010181905250878181518110611639577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6020026020010151606001805180919061165290612a31565b8152505060019150611672565b808061166a90612a31565b9150506114af565b50806117f657611680611f07565b8460200151816000019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505082816020018190525060028054905067ffffffffffffffff81111561170a577f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b60405190808252806020026020018201604052801561174357816020015b611730611f45565b8152602001906001900390816117285790505b50816040018190525084816040015160008151811061178b577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b60200260200101819052506001816060018181525050808888815181106117db577f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b602002602001018190525086806117f190612a31565b975050505b50505050808061180590612a31565b91505061123a565b50819250505090565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff166118a4576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161189b90612790565b60405180910390fd5b6000604051806080016040528060055481526020013373ffffffffffffffffffffffffffffffffffffffff168152602001838152602001428152509050600560008154809291906118f490612a31565b919050555060028190806001815401808255809150506001900390600052602060002090600402016000909190919091506000820151816000015560208201518160010160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506040820151816002019080519060200190611992929190611e36565b506060820151816003015550505050565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff16611a31576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611a2890612790565b60405180910390fd5b600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082815260200190815260200160002060009054906101000a900460ff1615611acf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611ac690612770565b60405180910390fd5b6000604051806080016040528083815260200160075481526020016000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000018054611b36906129ff565b80601f0160208091040260200160405190810160405280929190818152602001828054611b62906129ff565b8015611baf5780601f10611b8457610100808354040283529160200191611baf565b820191906000526020600020905b815481529060010190602001808311611b9257829003601f168201915b50505050508152602001428152509050600481908060018154018082558091505060019003906000526020600020906004020160009091909190915060008201518160000155602082015181600101556040820151816002019080519060200190611c1b929190611e36565b5060608201518160030155505060076000815480929190611c3b90612a31565b919050555060018060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600084815260200190815260200160002060006101000a81548160ff0219169083151502179055505050565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060020160009054906101000a900460ff1615611d3b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611d32906127b0565b60405180910390fd5b60006040518060600160405280838152602001428152602001600115158152509050806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000820151816000019080519060200190611db8929190611e36565b506020820151816001015560408201518160020160006101000a81548160ff0219169083151502179055509050505050565b6040518060c00160405280600081526020016000815260200160608152602001600073ffffffffffffffffffffffffffffffffffffffff16815260200160608152602001600081525090565b828054611e42906129ff565b90600052602060002090601f016020900481019282611e645760008555611eab565b82601f10611e7d57805160ff1916838001178555611eab565b82800160010185558215611eab579182015b82811115611eaa578251825591602001919060010190611e8f565b5b509050611eb89190611f83565b5090565b6040518060800160405280600081526020016000815260200160608152602001600081525090565b604051806060016040528060608152602001600081526020016000151581525090565b6040518060800160405280600073ffffffffffffffffffffffffffffffffffffffff1681526020016060815260200160608152602001600081525090565b604051806080016040528060008152602001600073ffffffffffffffffffffffffffffffffffffffff16815260200160608152602001600081525090565b5b80821115611f9c576000816000905550600101611f84565b5090565b6000611fb3611fae84612823565b6127f2565b905082815260208101848484011115611fcb57600080fd5b611fd68482856129bd565b509392505050565b600081359050611fed81612b18565b92915050565b600082601f83011261200457600080fd5b8135612014848260208601611fa0565b91505092915050565b60008135905061202c81612b2f565b92915050565b60006020828403121561204457600080fd5b600061205284828501611fde565b91505092915050565b60006020828403121561206d57600080fd5b600082013567ffffffffffffffff81111561208757600080fd5b61209384828501611ff3565b91505092915050565b6000602082840312156120ae57600080fd5b60006120bc8482850161201d565b91505092915050565b600080604083850312156120d857600080fd5b60006120e68582860161201d565b925050602083013567ffffffffffffffff81111561210357600080fd5b61210f85828601611ff3565b9150509250929050565b600061212583836124c9565b905092915050565b60006121398383612559565b905092915050565b600061214d83836125bc565b905092915050565b6000612161838361261f565b905092915050565b61217281612975565b82525050565b600061218382612893565b61218d81856128fe565b93508360208202850161219f85612853565b8060005b858110156121db57848403895281516121bc8582612119565b94506121c7836128ca565b925060208a019950506001810190506121a3565b50829750879550505050505092915050565b60006121f88261289e565b612202818561290f565b93508360208202850161221485612863565b8060005b858110156122505784840389528151612231858261212d565b945061223c836128d7565b925060208a01995050600181019050612218565b50829750879550505050505092915050565b600061226d826128a9565b6122778185612920565b93508360208202850161228985612873565b8060005b858110156122c557848403895281516122a68582612141565b94506122b1836128e4565b925060208a0199505060018101905061228d565b50829750879550505050505092915050565b60006122e2826128a9565b6122ec8185612931565b9350836020820285016122fe85612873565b8060005b8581101561233a578484038952815161231b8582612141565b9450612326836128e4565b925060208a01995050600181019050612302565b50829750879550505050505092915050565b6000612357826128b4565b6123618185612942565b93508360208202850161237385612883565b8060005b858110156123af57848403895281516123908582612155565b945061239b836128f1565b925060208a01995050600181019050612377565b50829750879550505050505092915050565b6123ca81612987565b82525050565b60006123db826128bf565b6123e58185612953565b93506123f58185602086016129cc565b6123fe81612b07565b840191505092915050565b6000612416601c83612964565b91507f5573657220616c7265616479206c696b6564207468697320706f7374000000006000830152602082019050919050565b6000612456601383612964565b91507f55736572206e6f742072656769737465726564000000000000000000000000006000830152602082019050919050565b6000612496601783612964565b91507f5573657220616c726561647920726567697374657265640000000000000000006000830152602082019050919050565b600060c0830160008301516124e160008601826126d9565b5060208301516124f460208601826126d9565b506040830151848203604086015261250c82826123d0565b91505060608301516125216060860182612169565b506080830151848203608086015261253982826123d0565b91505060a083015161254e60a08601826126d9565b508091505092915050565b600060808301600083015161257160008601826126d9565b50602083015161258460208601826126d9565b506040830151848203604086015261259c82826123d0565b91505060608301516125b160608601826126d9565b508091505092915050565b60006080830160008301516125d460008601826126d9565b5060208301516125e76020860182612169565b50604083015184820360408601526125ff82826123d0565b915050606083015161261460608601826126d9565b508091505092915050565b60006080830160008301516126376000860182612169565b506020830151848203602086015261264f82826123d0565b915050604083015184820360408601526126698282612262565b915050606083015161267e60608601826126d9565b508091505092915050565b600060608301600083015184820360008601526126a682826123d0565b91505060208301516126bb60208601826126d9565b5060408301516126ce60408601826123c1565b508091505092915050565b6126e2816129b3565b82525050565b600060208201905081810360008301526127028184612178565b905092915050565b6000602082019050818103600083015261272481846121ed565b905092915050565b6000602082019050818103600083015261274681846122d7565b905092915050565b60006020820190508181036000830152612768818461234c565b905092915050565b6000602082019050818103600083015261278981612409565b9050919050565b600060208201905081810360008301526127a981612449565b9050919050565b600060208201905081810360008301526127c981612489565b9050919050565b600060208201905081810360008301526127ea8184612689565b905092915050565b6000604051905081810181811067ffffffffffffffff8211171561281957612818612ad8565b5b8060405250919050565b600067ffffffffffffffff82111561283e5761283d612ad8565b5b601f19601f8301169050602081019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b6000819050602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b6000602082019050919050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600082825260208201905092915050565b600061298082612993565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b82818337600083830152505050565b60005b838110156129ea5780820151818401526020810190506129cf565b838111156129f9576000848401525b50505050565b60006002820490506001821680612a1757607f821691505b60208210811415612a2b57612a2a612aa9565b5b50919050565b6000612a3c826129b3565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff821415612a6f57612a6e612a7a565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b612b2181612975565b8114612b2c57600080fd5b50565b612b38816129b3565b8114612b4357600080fd5b5056fea2646970667358221220f565c83fd7919a72ddc510ff592b1b4f31582d4e3858d5d00cdec406ead6032864736f6c63430008000033"

abi = [{'inputs': [{'internalType': 'uint256', 'name': '_PostId', 'type': 'uint256'}], 'name': 'GetCommentsOnPost', 'outputs': [{'components': [{'internalType': 'uint256', 'name': 'postId', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'commentId', 'type': 'uint256'}, {'internalType': 'string', 'name': 'username', 'type': 'string'}, {'internalType': 'address', 'name': 'author', 'type': 'address'}, {'internalType': 'string', 'name': 'content', 'type': 'string'}, {'internalType': 'uint256', 'name': 'timestamp', 'type': 'uint256'}], 'internalType': 'struct CommunityDapp.Comment[]', 'name': '', 'type': 'tuple[]'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'uint256', 'name': '_PostId', 'type': 'uint256'}], 'name': 'GetLikesOnPost', 'outputs': [{'components': [{'internalType': 'uint256', 'name': 'postId', 'type': 'uint256'}, {'internalType': 'uint256', 'name': 'likeId', 'type': 'uint256'}, {'internalType': 'string', 'name': 'username', 'type': 'string'}, {'internalType': 'uint256', 'name': 'timestamp', 'type': 'uint256'}], 'internalType': 'struct CommunityDapp.Like[]', 'name': '', 'type': 'tuple[]'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'uint256', 'name': '_postId', 'type': 'uint256'}, {'internalType': 'string', 'name': '_comment', 'type': 'string'}], 'name': 'comment', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [], 'name': 'getPosts', 'outputs': [{'components': [{'internalType': 'uint256', 'name': 'id', 'type': 'uint256'}, {'internalType': 'address', 'name': 'author', 'type': 'address'}, {'internalType': 'string', 'name': 'content', 'type': 'string'}, {'internalType': 'uint256', 'name': 'timestamp', 'type': 'uint256'}], 'internalType': 'struct CommunityDapp.Post[]', 'name': '', 'type': 'tuple[]'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'address', 'name': 'userAddress', 'type': 'address'}], 'name': 'getUser', 'outputs': [{'components': [{'internalType': 'string', 'name': 'name', 'type': 'string'}, {'internalType': 'uint256', 'name': 'joinedTimestamp', 'type': 'uint256'}, {'internalType': 'bool', 'name': 'registered', 'type': 'bool'}], 'internalType': 'struct CommunityDapp.User', 'name': '', 'type': 'tuple'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [], 'name': 'getUsersWithPosts', 'outputs': [{'components': [{'internalType': 'address', 'name': 'userAddress', 'type': 'address'}, {'internalType': 'string', 'name': 'username', 'type': 'string'}, {'components': [{'internalType': 'uint256', 'name': 'id', 'type': 'uint256'}, {'internalType': 'address', 'name': 'author', 'type': 'address'}, {'internalType': 'string', 'name': 'content', 'type': 'string'}, {'internalType': 'uint256', 'name': 'timestamp', 'type': 'uint256'}], 'internalType': 'struct CommunityDapp.Post[]', 'name': 'posts', 'type': 'tuple[]'}, {'internalType': 'uint256', 'name': 'postCount', 'type': 'uint256'}], 'internalType': 'struct CommunityDapp.UserWithPosts[]', 'name': '', 'type': 'tuple[]'}], 'stateMutability': 'view', 'type': 'function'}, {'inputs': [{'internalType': 'uint256', 'name': '_postId', 'type': 'uint256'}], 'name': 'like', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'string', 'name': 'content', 'type': 'string'}], 'name': 'post', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}, {'inputs': [{'internalType': 'string', 'name': 'name', 'type': 'string'}], 'name': 'register', 'outputs': [], 'stateMutability': 'nonpayable', 'type': 'function'}]

parser = argparse.ArgumentParser(description='chat community app over spolia test network  needs: ')
parser.add_argument('-pub', dest='public_key', required=True, help='Public key argument')
parser.add_argument('-priv', dest='private_key', required=True, help='Private key argument')

args = parser.parse_args()

my_address = args.public_key
private_key = args.private_key

infura_endpoint = 'https://sepolia.infura.io/v3/974a593428c24f91bc674fc5a7b599c5'  # infura API spolia test net 
w3 = Web3(Web3.HTTPProvider(infura_endpoint))
# w3 = Web3(Web3.HTTPProvider("http://127.0.0.1:7545"))
chain_id = 11155111
print ("my_address : " , my_address)
print("private_key : ", private_key)
##################### 0xa547d4184A31600A75701970f5094C071b49EF9c #####################smart contract address


def register(interactive_functions,username , chain_id , my_address ):
    try: 
        global w3 ,private_key
        nonce = w3.eth.get_transaction_count(my_address)
        register_on_blockchain = interactive_functions.functions.register(username).build_transaction(
        {
            "chainId": chain_id,
            "gasPrice": w3.eth.gas_price,
            "from": my_address,
            "nonce": nonce ,
        }
        )
        signed_greeting_txn = w3.eth.account.sign_transaction(
        register_on_blockchain, private_key=private_key
        )
        tx_greeting_hash = w3.eth.send_raw_transaction(signed_greeting_txn.rawTransaction)
        return "Registered successfully ! "
    except  ContractLogicError: 
        return "User already registered or username is already exsists ! "

def post(interactive_functions,what_to_send , chain_id , my_address ):
    try: 
        global w3 , private_key
        nonce = w3.eth.get_transaction_count(my_address)
        register_on_blockchain = interactive_functions.functions.post(what_to_send).build_transaction(
        {
            "chainId": chain_id,
            "gasPrice": w3.eth.gas_price,
            "from": my_address,
            "nonce": nonce ,
        }
        )
        signed_greeting_txn = w3.eth.account.sign_transaction(
        register_on_blockchain, private_key=private_key
        )
        tx_greeting_hash = w3.eth.send_raw_transaction(signed_greeting_txn.rawTransaction)
        return " post successfully ! "
    except  ContractLogicError: 
        return "something happend ! "   

def Comment(interactive_functions,postId , what_to_send, my_address, chain_id ): 
    try: 
        global w3 , private_key
        nonce = w3.eth.get_transaction_count(my_address)
        register_on_blockchain = interactive_functions.functions.comment(postId, what_to_send).build_transaction(
        {
            "chainId": chain_id,
            "gasPrice": w3.eth.gas_price,
            "from": my_address,
            "nonce": nonce ,
        }
        )
        signed_txn = w3.eth.account.sign_transaction(
        register_on_blockchain, private_key=private_key
        )
        tx_greeting_hash = w3.eth.send_raw_transaction(signed_txn.rawTransaction)
        return " Comment successfully ! "
    except  ContractLogicError: 
        return "something happend ! "   

def Like(interactive_functions,postId , my_address, chain_id):
    try: 
        global w3 , private_key
        nonce = w3.eth.get_transaction_count(my_address)
        register_on_blockchain = interactive_functions.functions.like(postId).build_transaction(
        {
            "chainId": chain_id,
            "gasPrice": w3.eth.gas_price,
            "from": my_address,
            "nonce": nonce ,
        }
        )
        signed_txn = w3.eth.account.sign_transaction(
        register_on_blockchain, private_key=private_key
        )
        tx_greeting_hash = w3.eth.send_raw_transaction(signed_txn.rawTransaction)
        return " Like successfully ! "
    except  ContractLogicError: 
        return "something happend ! "   

def getUser(interactive_functions, my_address): 
    return interactive_functions.functions.getUser(my_address).call()

def getComments(interactive_functions , postId ): 
    Comments_before_filter = interactive_functions.functions.GetCommentsOnPost(postId).call()
    Comments_after_filter = [] 
    for i in Comments_before_filter:
        Comments_after_filter.append({"username": i[2] , "comment": i[4], "timestamp": return_readable_timestamp(i[5])} )
    return Comments_after_filter

def getLikes(interactive_functions , postId ): 
    return interactive_functions.functions.GetLikesOnPost(postId).call()


def return_readable_timestamp(timestamp): 
    return str(datetime.fromtimestamp(timestamp))

def get_all_post(interactive_functions):
    filtt = interactive_functions.functions.getUsersWithPosts().call()
    posts = [] 

    for i in filtt: 
        username = i[1]
        temp_posts = [] 
        temp_timestamp = [] 
        temp_postId = [] 
        temp_comments = [] 
        temp_likes_count  = [] 
        if (len(i[2])>0 ): 
            for  post in i[2]: 
                if(len(post[2]) > 0):
                    temp_postId.append(post[0])
                    temp_comments.append(getComments(interactive_functions, post[0] ))
                    temp_posts.append(post[2])
                    temp_timestamp.append(return_readable_timestamp( int(post[3])))
                    temp_likes_count.append(len(getLikes(interactive_functions,post[0])))
        #print("likes count :  ", len(temp_likes))
        if len(username) > 0:
            posts.append({"username": username ,"postIds": temp_postId, "posts":temp_posts, "timestamps":temp_timestamp , "Comments": temp_comments , "LikesCount": temp_likes_count}) 

    return posts

######################################### server code ####################################################

app = Flask(__name__)
app.config["SESSION_PERMANENT"] = True

CommunityChat_interactive_functions = w3.eth.contract(address='0xa547d4184A31600A75701970f5094C071b49EF9c', abi=abi)# tx_receipt.contractAddress
username= '' 
@app.route("/")
def home():
    global CommunityChat_interactive_functions , username , my_address
    user_tuple= getUser(CommunityChat_interactive_functions , my_address)
    userSigned_Check = user_tuple[2]
    username = user_tuple[0]
    if (userSigned_Check): 
        date_sign_up = return_readable_timestamp(int(user_tuple[1]))
        return render_template("index.html", userSigned_Check =userSigned_Check , username=username , date_sign_up=date_sign_up )
    else: 
        return render_template("index.html", userSigned_Check =userSigned_Check,  username=username)

@app.route('/register', methods=['POST'])
def reg():
    global username
    if request.method == 'POST':
        username = request.form.get('name')
        register(CommunityChat_interactive_functions, username, chain_id, my_address)


        print(f"registered successfully as {username}")
        return redirect("/post") 
    else: 
        return 'registered done!!'

@app.route("/Comment" , methods=['POST'])
def create_comment(): 
    if request.method == 'POST':
        postId = request.form.get("post_id")
        content_of_comment = request.form.get("comment_content")

        print(Comment(CommunityChat_interactive_functions, int(postId), content_of_comment, my_address, chain_id))
        return redirect('/post')

@app.route("/Like" , methods=['POST'])
def Like_post(): 
    if request.method == 'POST':
        postId = request.form.get("post_id")
        print(Like(CommunityChat_interactive_functions, int(postId), my_address, chain_id))
        return redirect('/post')


@app.route("/LikesForPost", methods= ['POST'])
def LikesForPost(): 
    if request.method == 'POST':
        postId = request.form.get("post_id")
        Likes_Tuple = getLikes(CommunityChat_interactive_functions, int(postId))
        Likes= [] 
        for i in Likes_Tuple: 
            Likes.append({"username": i[2], "timestamp": return_readable_timestamp(i[3])})
        return render_template("Likes.html", len1=len(Likes) , Likes=Likes)

@app.route('/post', methods=['GET', 'POST'])
def create_post():
    global username, CommunityChat_interactive_functions
    if request.method == 'POST':
        what_to_send = request.form.get('post_content')

        post(CommunityChat_interactive_functions, what_to_send, chain_id, my_address)
        messages = get_all_post(CommunityChat_interactive_functions)
        return render_template('chat.html', username=username, messages=messages)
    else:
        user_tuple = getUser(CommunityChat_interactive_functions, my_address)
        userSigned_Check = user_tuple[2]
        if not userSigned_Check:  # User is not registered
            return redirect(url_for('home'))
        else:
            messages = get_all_post(CommunityChat_interactive_functions)
            return render_template('chat.html', username=username, messages=messages)

if __name__ == "__main__":
    app.run(debug=True)        